{% extends "base.html" %}

{% block title %}Payment Certificates{% endblock %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto space-y-6">

  <!-- ================= Messages ================= -->
  {% if messages %}
  <div class="space-y-2 mb-6">
    {% for message in messages %}
    <div class="px-4 py-3 rounded text-sm font-semibold
                {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-300
                {% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-300
                {% else %}bg-gray-100 text-gray-800 border border-gray-300{% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
    <h2 class="text-2xl font-bold text-gray-800">Payment Certificates</h2>

    {% if perms.finance.add_paymentcertificate %}
    <a href="{% url 'finance:payment_add' %}"
       class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">
      + Add Payment
    </a>
    {% endif %}
  </div>

  <!-- Search -->
  <form id="searchForm" method="get" class="flex flex-wrap gap-3 items-center mb-4">
    <input type="text" name="q" value="{{ search|default:'' }}"
           placeholder="Search by project, certificate, payee..."
           id="searchInput"
           class="px-4 py-2 border rounded w-full sm:w-80" />
    {% if search %}
    <a href="{% url 'finance:payment_list' %}"
       class="px-4 py-2 rounded border text-sm text-gray-600 hover:bg-gray-100">
      Clear Search
    </a>
    {% endif %}
  </form>

  <!-- Payments Table -->
  <div class="overflow-x-auto bg-white shadow rounded">
    <table class="w-full text-sm divide-y divide-gray-100">
      <thead class="bg-gray-100 text-gray-700 text-xs sm:text-sm uppercase">
        <tr>
          <th class="p-3 text-left">Project</th>
          <th class="p-3 text-left">Certificate</th>
          <th class="p-3 text-left">Payee</th>
          <th class="p-3 text-right">Certified</th>
          <th class="p-3 text-right">Paid</th>
          <th class="p-3 text-left">Date</th>
          <th class="p-3 text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if payments %}
          {% for p in payments %}
          <tr class="hover:bg-gray-50 {% if not p.is_active %}opacity-50{% endif %}">
            <td class="p-3 font-semibold truncate max-w-[160px]">{{ p.project.project_name }}</td>
            <td class="p-3 truncate max-w-[120px]">{{ p.certificate_no }}</td>
            <td class="p-3 truncate max-w-[140px]">{{ p.amount_to }}</td>
            <td class="p-3 text-right">{{ p.certified_amount|floatformat:2 }}</td>
            <td class="p-3 text-right text-green-700 font-semibold">{{ p.amount_paid|floatformat:2 }}</td>
            <td class="p-3">{{ p.payment_date|date:"d M Y" }}</td>
            <td class="p-3 text-right flex justify-end gap-2 flex-wrap">
              <a href="{% url 'finance:payment_view' p.pk %}"
                 class="px-3 py-1 rounded bg-blue-500 text-white text-xs hover:bg-blue-600">
                View
              </a>
              {% if perms.finance.change_paymentcertificate %}
              <a href="{% url 'finance:payment_edit' p.pk %}"
                 class="px-3 py-1 rounded bg-yellow-500 text-white text-xs hover:bg-yellow-600">
                Edit
              </a>
              {% endif %}
              {% if perms.finance.delete_paymentcertificate %}
              <a href="{% url 'finance:payment_delete' p.pk %}"
                 class="px-3 py-1 rounded bg-red-500 text-white text-xs hover:bg-red-600">
                Delete
              </a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="p-6 text-center text-gray-500">
              No payments recorded.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if payments %}
    {% include "partials/pagination.html" with page_obj=payments search=search %}
  {% endif %}

</div>

<!-- Debounce search JS -->
<script>
  let timer;
  const input = document.getElementById('searchInput');
  const form = document.getElementById('searchForm');

  input.addEventListener('input', function() {
    clearTimeout(timer);
    timer = setTimeout(() => {
      form.submit();
    }, 500); // 500ms debounce
  });
</script>

{% endblock %}
