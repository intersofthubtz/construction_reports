{% extends "base.html" %}

{% block title %}Fund Transactions{% endblock %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto space-y-6">

  <!-- ================= Messages ================= -->
  {% if messages %}
  <div class="space-y-2 mb-6">
    {% for message in messages %}
      <div class="px-4 py-3 rounded text-sm font-semibold
                  {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-300
                  {% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-300
                  {% else %}bg-gray-100 text-gray-800 border border-gray-300{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
    <h2 class="text-2xl font-bold text-gray-800">Fund Transactions</h2>

    {% if perms.finance.add_fundtransaction %}
    <a href="{% url 'finance:transaction_add' %}"
       class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">
      + Add Transaction
    </a>
    {% endif %}
  </div>

  <!-- Search -->
  <form id="searchForm" method="get" class="flex flex-wrap gap-3 items-center mb-4">
    <input type="text" name="q" value="{{ search|default:'' }}"
           placeholder="Search by payee, type, or ref no..."
           id="searchInput"
           class="px-4 py-2 border rounded w-full sm:w-80" />
    {% if search %}
    <a href="{% url 'finance:transaction_list' %}"
       class="px-4 py-2 rounded border text-sm text-gray-600 hover:bg-gray-100">
      Clear
    </a>
    {% endif %}
  </form>

  <!-- Transactions Table -->
  <div class="overflow-x-auto bg-white shadow rounded">
    <table class="w-full text-sm divide-y divide-gray-100">
      <thead class="bg-gray-100 text-gray-700 text-xs sm:text-sm uppercase">
        <tr>
          <th class="p-3 text-left">Date</th>
          <th class="p-3 text-left">Payee</th>
          <th class="p-3 text-left">Type</th>
          <th class="p-3 text-right">Amount</th>
          <th class="p-3 text-right">Balance</th>
          <th class="p-3 text-left">Ref No</th>
          <th class="p-3 text-left">Remarks</th>
          <th class="p-3 text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if transactions %}
          {% for t in transactions %}
          <tr class="hover:bg-gray-50 {% if not t.is_active %}opacity-50{% endif %}">
            <td class="p-3">{{ t.date|date:"d M Y" }}</td>
            <td class="p-3 font-semibold truncate max-w-[160px]">{{ t.payee }}</td>

            <td class="p-3">
              <span class="px-2 py-1 rounded text-xs font-semibold
                {% if t.type == 'Credit' %}bg-green-100 text-green-700
                {% else %}bg-red-100 text-red-700{% endif %}">
                {{ t.type }}
              </span>
            </td>

            <td class="p-3 text-right font-semibold">{{ t.amount_paid|floatformat:2 }}</td>
            <td class="p-3 text-right text-blue-700 font-semibold">{{ t.balance_after|floatformat:2 }}</td>
            <td class="p-3 truncate max-w-[120px]">{{ t.pv_or_receipt_no }}</td>
            <td class="p-3 truncate max-w-[180px]">{{ t.remarks|default:"â€”" }}</td>

            <!-- Actions -->
            <td class="p-3 flex justify-end gap-2 flex-wrap">
              <a href="{% url 'finance:transaction_view' t.pk %}"
                 class="px-3 py-1 rounded bg-blue-500 text-white text-xs hover:bg-blue-600">
                View
              </a>

              {% if perms.finance.change_fundtransaction %}
              <a href="{% url 'finance:transaction_edit' t.pk %}"
                 class="px-3 py-1 rounded bg-yellow-500 text-white text-xs hover:bg-yellow-600">
                Edit
              </a>
              {% endif %}

              {% if perms.finance.delete_fundtransaction %}
              <a href="{% url 'finance:transaction_delete' t.pk %}"
                 class="px-3 py-1 rounded bg-red-500 text-white text-xs hover:bg-red-600">
                Delete
              </a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="p-6 text-center text-gray-500">
              No transactions recorded.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if transactions %}
    {% include "partials/pagination.html" with page_obj=transactions search=search %}
  {% endif %}

</div>

<!-- Debounce search JS -->
<script>
  let timer;
  const input = document.getElementById('searchInput');
  const form = document.getElementById('searchForm');

  input.addEventListener('input', function() {
    clearTimeout(timer);
    timer = setTimeout(() => {
      form.submit();
    }, 500); // 500ms debounce for smooth typing
  });
</script>

{% endblock %}
