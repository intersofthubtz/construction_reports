{% extends "base.html" %}
{% block title %}Project Images{% endblock %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto space-y-6">

  <!-- Header + Add Button -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6 flex-wrap">
    <h2 class="text-2xl font-bold text-gray-800">Project Images</h2>
    {% if perms.sitemanage.add_siteprojectimage %}
      <a href="{% url 'sitemanage:site_project_image_create' %}"
         class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-semibold">
        + Upload Project Image
      </a>
    {% endif %}
  </div>

  <!-- Success Messages -->
  {% if messages %}
    <div class="space-y-2">
      {% for message in messages %}
        {% if message.tags == "success" %}
          <div class="px-4 py-2 rounded bg-green-100 text-green-800">
            {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <!-- Search -->
  <form id="searchForm" method="get" class="mb-4 flex gap-2 items-center">
    <input type="text" id="searchInput" name="q" value="{{ search|default:'' }}" 
           placeholder="Search by project or figure name"
           class="border rounded px-3 py-2 w-full sm:w-1/3">

    {% if search %}
      <a href="{% url 'sitemanage:site_project_image_list' %}" 
         class="px-4 py-2 border rounded text-gray-600 hover:bg-gray-100">
        Clear Search
      </a>
    {% endif %}
  </form>

  <!-- Images Table -->
  <div class="bg-white shadow rounded overflow-x-auto">
    <table class="w-full text-sm divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr class="text-gray-600 uppercase text-xs tracking-wide">
          <th class="p-3 text-left">Project</th>
          <th class="p-3 text-left">Activity</th>
          <th class="p-3 text-left">Preview</th>
          <th class="p-3 text-left">Image Date</th>
          <th class="p-3 text-right">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for image in images %}
          <tr class="hover:bg-gray-50 transition">
            <td class="p-3">{{ image.project.project_name }}</td>
            <td class="p-3">{{ image.activity.name|default:"General" }}</td>
            <td class="p-3">
              <a href="{% url 'sitemanage:site_project_image_detail' image.pk %}">
                <img src="{{ image.image.url }}" alt="{{ image.figure_name }}" class="w-20 h-20 object-cover rounded hover:opacity-80 transition">
              </a>
            </td>
            <td class="p-3">{{ image.image_date }}</td>
            <td class="p-3 text-right flex justify-end gap-2">
              {% if perms.sitemanage.change_siteprojectimage %}
                <a href="{% url 'sitemanage:site_project_image_edit' image.pk %}"
                   class="px-3 py-1 rounded bg-yellow-500 text-white hover:bg-yellow-600 text-xs font-semibold">
                  Edit
                </a>
              {% endif %}
              {% if perms.sitemanage.delete_siteprojectimage %}
                <a href="{% url 'sitemanage:site_project_image_delete' image.pk %}"
                   class="px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600 text-xs font-semibold">
                  Delete
                </a>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="p-6 text-center text-gray-500">No project images found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% include "partials/pagination.html" with page_obj=images search=search %}

</div>

<!-- Debounced search -->
<script>
  let timer;
  const input = document.getElementById('searchInput');
  const form = document.getElementById('searchForm');

  input.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(() => form.submit(), 500); // submit after 500ms
  });
</script>

{% endblock %}
