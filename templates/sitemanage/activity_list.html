{% extends "base.html" %}

{% block title %}Activities{% endblock %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto space-y-6">

  <!-- Messages -->
  {% if messages %}
  <div class="space-y-3 mb-4">
    {% for message in messages %}
      <div class="px-4 py-3 rounded-lg text-sm font-semibold
                  {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-300
                  {% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-300
                  {% else %}bg-gray-100 text-gray-800 border border-gray-300{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
    <h2 class="text-2xl font-bold text-gray-800">Activities</h2>

    {% if perms.sitemanage.add_activity %}
    <a href="{% url 'sitemanage:activity_create' %}"
       class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold">
      + Add Activity
    </a>
    {% endif %}
  </div>

  <!-- Search & Filter -->
  <form id="searchForm" method="get" class="flex flex-wrap gap-3 items-center mb-4">
    <input type="text" name="q" id="searchInput" value="{{ search|default:'' }}"
           placeholder="Search activity, project..."
           class="px-4 py-2 border rounded text-sm w-full sm:w-80">

    <select name="status" id="statusFilter" class="px-4 py-2 border rounded text-sm">
      <option value="">All Status</option>
      <option value="Pending" {% if status == "Pending" %}selected{% endif %}>Pending</option>
      <option value="In Progress" {% if status == "In Progress" %}selected{% endif %}>In Progress</option>
      <option value="Completed" {% if status == "Completed" %}selected{% endif %}>Completed</option>
      <option value="Delayed" {% if status == "Delayed" %}selected{% endif %}>Delayed</option>
    </select>

    {% if search or status %}
    <a href="{% url 'sitemanage:activity_list' %}"
       class="px-4 py-2 rounded border text-sm text-gray-600 hover:bg-gray-100">
      Clear Search
    </a>
    {% endif %}
  </form>

  <!-- Table -->
  <div class="overflow-x-auto bg-white shadow rounded">
    <table class="w-full text-sm divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr class="text-gray-600 uppercase text-xs tracking-wide">
          <th class="p-3 text-left">Activity</th>
          <th class="p-3 text-left">Project</th>
          <th class="p-3 text-left">Planned Start</th>
          <th class="p-3 text-left">Planned End</th>
          <th class="p-3 text-left">Status</th>
          <th class="p-3 text-left">Progress</th>
          <th class="p-3 text-right">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% if activities %}
          {% for activity in activities %}
          <tr class="hover:bg-gray-50 transition">
            <td class="p-3 font-semibold text-gray-900">{{ activity.name }}</td>
            <td class="p-3 text-gray-600">{{ activity.project.project_name|capfirst }}</td>
            <td class="p-3 text-gray-700">{{ activity.planned_start|default:"-" }}</td>
            <td class="p-3 text-gray-700">{{ activity.planned_end|default:"-" }}</td>
            <td class="p-3">
              <span class="px-3 py-1 rounded-full text-xs font-semibold
                {% if activity.status == 'Completed' %}bg-green-100 text-green-700
                {% elif activity.status == 'In Progress' %}bg-blue-100 text-blue-700
                {% elif activity.status == 'Delayed' %}bg-red-100 text-red-700
                {% else %}bg-gray-100 text-gray-700{% endif %}">
                {{ activity.status|default:"-" }}
              </span>
            </td>
            <td class="p-3 w-40">
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-blue-500 h-3 rounded-full" style="width: {{ activity.progress_percent }}%"></div>
              </div>
              <span class="text-gray-700 text-xs font-semibold">{{ activity.progress_percent }}%</span>
            </td>
            <td class="p-3 text-right flex flex-wrap gap-2 justify-end">
              {% if perms.sitemanage.view_activity %}
              <a href="{% url 'sitemanage:activity_detail' activity.pk %}"
                 class="px-3 py-1 rounded bg-green-500 text-white hover:bg-green-600 text-xs font-semibold">View</a>
              {% endif %}

              {% if perms.sitemanage.change_activity %}
              <a href="{% url 'sitemanage:activity_update' activity.pk %}"
                 class="px-3 py-1 rounded bg-yellow-500 text-white hover:bg-yellow-600 text-xs font-semibold">Edit</a>
              {% endif %}

              {% if perms.sitemanage.delete_activity %}
              <a href="{% url 'sitemanage:activity_delete' activity.pk %}"
                 class="px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600 text-xs font-semibold">Delete</a>
              {% endif %}

              {% if perms.sitemanage.view_progresslog %}
              <a href="{% url 'sitemanage:progress_log_list' activity.pk %}"
                 class="px-3 py-1 rounded bg-blue-500 text-white hover:bg-blue-600 text-xs font-semibold">Progress Logs</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="p-6 text-center text-gray-500">No activities found.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if activities.paginator.num_pages > 1 %}
    {% include "partials/pagination.html" with page_obj=activities search=search status=status %}
  {% endif %}

</div>

<!-- Debounce search & filter -->
<script>
  let timer;
  const input = document.getElementById('searchInput');
  const statusSelect = document.getElementById('statusFilter');
  const form = document.getElementById('searchForm');

  function submitFormDebounced() {
    clearTimeout(timer);
    timer = setTimeout(() => form.submit(), 500);
  }

  input.addEventListener('input', submitFormDebounced);
  statusSelect.addEventListener('change', submitFormDebounced);
</script>

{% endblock %}
